# windows messages

## 概念
系统以消息的形式将 input 传递给 window 过程。消息由系统和应用程序生成。系统在每个输入事件时生成一条消息，例如，当用户键入、移动鼠标或单击滚动条等控件时。系统还会生成消息以响应应用程序带来的系统更改，例如，当应用程序更改系统字体资源池或调整其窗口之一的大小时。应用程序可以生成消息，以指示自己的窗口执行任务或与其他应用程序中的窗口通信

系统使用一组四个参数将消息发送到窗口过程：窗口句柄、消息标识符和两个称为消息参数的值。窗口句柄标识消息所针对的窗口。系统使用它来确定哪个窗口过程应接收消息

消息标识符是标识消息目的的命名常量。当窗口过程收到消息时，它使用消息标识符来确定如何处理该消息

## 系统定义的消息


## 应用程序定义的消息
应用程序可以创建供其自己的窗口使用或与其他进程中的窗口通信的消息。如果应用程序创建自己的消息，则接收这些消息的窗口过程必须解释消息并提供适当的处理

系统为系统定义的消息保留 0x0000 到 0x03FF 范围内的消息标识符值（值 WM_USER – 1）。应用程序不能将这些值用于私人消息

范围 0x0400 （值 WM_USER） 到 0x7FFF 中的值可用于专用窗口类的消息标识符

如果您的应用程序标记为版本 4.0，则可以将 0x8000 （WM_APP） 到 0xBFFF 范围内的消息标识符值用于私人消息

当应用程序调用 RegisterWindowMessage 函数注册消息时，系统将返回 0xC000 到 0xFFFF 范围内的消息标识符。此函数返回的消息标识符保证在整个系统中是唯一的。使用此功能可以防止其他应用程序将同一消息标识符用于不同目的时可能发生的冲突

## 消息路由
系统使用两种方法将消息路由到窗口过程：将消息发布到称为消息队列的先进先出队列、临时存储消息的系统定义的内存对象，以及将消息直接发送到窗口过程

发布到消息队列的消息称为排队消息。这些主要是用户通过鼠标或键盘输入的结果，例如 WM_MOUSEMOVE、WM_LBUTTONDOWN、WM_KEYDOWN 和 WM_CHAR 消息。其他排队消息包括 timer、paint 和 quit 消息：WM_TIMER、WM_PAINT 和 WM_QUIT。大多数直接发送到窗口过程的其他消息称为非排队消息

系统一次可以显示任意数量的窗口。要将鼠标和键盘输入路由到相应的窗口，系统使用消息队列

系统为每个 GUI 线程维护一个系统消息队列和一个特定于线程的消息队列。为避免为非 GUI 线程创建消息队列的开销，所有线程最初都是在没有消息队列的情况下创建的。仅当线程首次调用特定用户函数之一时，系统才会创建特定于线程的消息队列;没有 GUI 函数调用会导致创建消息队列

每当用户移动鼠标、单击鼠标按钮或在键盘上键入内容时，鼠标或键盘的设备驱动程序都会将输入转换为消息，并将其放入系统消息队列中。系统从系统消息队列中删除消息，一次删除一条消息，检查它们以确定目标窗口，然后将它们发布到创建目标窗口的线程的消息队列中。线程的消息队列接收线程创建的窗口的所有鼠标和键盘消息。线程从其队列中删除消息，并指示系统将其发送到相应的窗口过程进行处理

除了 WM_PAINT 消息、WM_TIMER 消息和 WM_QUIT 消息外，系统始终在消息队列的末尾发布消息。这可确保窗口以正确的先进先出 （FIFO） 序列接收其 input 消息。但是，WM_PAINT消息、WM_TIMER 消息和 WM_QUIT 消息将保留在队列中，并且仅当队列不包含其他消息时，才会转发到窗口过程。此外，同一窗口的多个 WM_PAINT 消息将合并为单个 WM_PAINT 消息，从而将工作区的所有无效部分合并到一个区域中。合并WM_PAINT消息可以减少窗口必须重绘其工作区内容的次数

系统通过填充 MSG 结构，然后将其复制到消息队列，将消息发布到线程的消息队列。MSG 中的信息包括：消息所针对的窗口的句柄、消息标识符、两个消息参数、消息的发布时间以及鼠标光标位置。线程可以使用 PostMessage 或 PostThreadMessage 函数将消息发布到自己的消息队列或另一个线程的队列


























